<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Horas Extras - Principal</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .icon-calc { background-color: #3498db; }
        .icon-data { background-color: #9b59b6; }
        .icon-history { background-color: #e74c3c; }
        .icon-summary { background-color: #27ae60; }
        .icon-config { background-color: #f39c12; }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }
        
        .card-subtitle {
            font-size: 14px;
            color: var(--gray-color);
            margin: 5px 0 0 0;
        }
        
        .card-content {
            font-size: 14px;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .card-actions {
            margin-top: 20px;
        }
        
        .user-info {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .user-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #9b59b6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }
        
        .user-text h3 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .user-text p {
            margin: 5px 0 0 0;
            color: var(--gray-color);
            font-size: 14px;
        }
        
        .user-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--gray-color);
            text-transform: uppercase;
        }
        
        .recent-activity {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .activity-list {
            margin-top: 15px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
        }
        
        .activity-content p {
            margin: 0;
            font-size: 14px;
        }
        
        .activity-time {
            font-size: 12px;
            color: var(--gray-color);
        }
        
        @media (max-width: 768px) {
            .user-info {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }
            
            .user-stats {
                width: 100%;
                justify-content: space-between;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-calculator"></i> Calculadora de Horas Extras</h1>
            <nav>
                <a href="main.html" class="active"><i class="fas fa-home"></i> Inicio</a>
                <a href="datos.html"><i class="fas fa-clock"></i> Introducir Datos</a>
                <a href="calculo.html"><i class="fas fa-calculator"></i> Calcular</a>
                <a href="historial.html"><i class="fas fa-history"></i> Historial</a>
                <a href="resumen.html"><i class="fas fa-chart-bar"></i> Resumen</a>
                <a href="config.html"><i class="fas fa-cog"></i> Configuración</a>
                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Salir</a>
            </nav>
        </header>

        <main>
            <div class="user-info">
                <div class="user-details">
                    <div class="user-avatar" id="userAvatar">
                        <!-- Se llena con JS -->
                    </div>
                    <div class="user-text">
                        <h3 id="userName">Usuario</h3>
                        <p id="userRole">Rol</p>
                        <p id="lastLogin">Último acceso: --</p>
                    </div>
                </div>
                
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalCalculos">0</div>
                        <div class="stat-label">Cálculos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalHoras">0</div>
                        <div class="stat-label">Horas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalImporte">0€</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
            </div>

            <div class="dashboard">
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon icon-calc">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div>
                            <h3 class="card-title">Calcular Horas</h3>
                            <p class="card-subtitle">Nuevo cálculo</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <p>Realiza un nuevo cálculo de horas extras con la fecha y horarios específicos.</p>
                    </div>
                    <div class="card-actions">
                        <a href="calculo.html" class="btn-secondary">
                            <i class="fas fa-plus"></i> Nuevo Cálculo
                        </a>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon icon-data">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <h3 class="card-title">Introducir Datos</h3>
                            <p class="card-subtitle">Gestión de horarios</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <p>Introduce tus horarios de trabajo para calcular automáticamente las horas extras.</p>
                    </div>
                    <div class="card-actions">
                        <a href="datos.html" class="btn-secondary">
                            <i class="fas fa-edit"></i> Gestionar Datos
                        </a>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon icon-history">
                            <i class="fas fa-history"></i>
                        </div>
                        <div>
                            <h3 class="card-title">Historial</h3>
                            <p class="card-subtitle">Todos los cálculos</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <p>Consulta, filtra y exporta todos tus cálculos anteriores con filtros por fecha.</p>
                    </div>
                    <div class="card-actions">
                        <a href="historial.html" class="btn-secondary">
                            <i class="fas fa-search"></i> Ver Historial
                        </a>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon icon-summary">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div>
                            <h3 class="card-title">Resumen Mensual</h3>
                            <p class="card-subtitle">Estadísticas y gráficos</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <p>Visualiza gráficos y estadísticas mensuales de tus horas extras y ganancias.</p>
                    </div>
                    <div class="card-actions">
                        <a href="resumen.html" class="btn-secondary">
                            <i class="fas fa-chart-line"></i> Ver Resumen
                        </a>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon icon-config">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div>
                            <h3 class="card-title">Configuración</h3>
                            <p class="card-subtitle">Personalizar sistema</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <p>Configura tarifas, festivos, usuarios y preferencias del sistema.</p>
                    </div>
                    <div class="card-actions">
                        <a href="config.html" class="btn-secondary">
                            <i class="fas fa-sliders-h"></i> Configurar
                        </a>
                    </div>
                </div>
            </div>

            <div class="recent-activity">
                <h2><i class="fas fa-bell"></i> Actividad Reciente</h2>
                <div class="activity-list" id="activityList">
                    <!-- Se llena con JS -->
                </div>
            </div>
        </main>

        <footer>
            <p>Sistema de cálculo de horas extras | 
                <span id="storageStatus">
                    <i class="fas fa-user-shield"></i> Sesión activa
                </span>
            </p>
            <div class="footer-info">
                <small id="sessionInfo">Usuario: -- | Última actividad: --</small>
            </div>
        </footer>
    </div>

    <script src="auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación
            if (!requireAuth()) return;
            
            const user = auth.getCurrentUser();
            
            // Mostrar información del usuario
            document.getElementById('userName').textContent = user.name || user.username;
            document.getElementById('userRole').textContent = user.role === 'admin' ? 'Administrador' : 'Usuario';
            
            // Avatar con iniciales
            const avatar = document.getElementById('userAvatar');
            const initials = (user.name || user.username).split(' ').map(n => n[0]).join('').toUpperCase();
            avatar.textContent = initials.substring(0, 2);
            
            // Cargar estadísticas
            loadStats();
            
            // Cargar actividad reciente
            loadRecentActivity();
            
            // Actualizar última actividad
            updateLastActivity();
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                    auth.logout();
                }
            });
            
            // Actualizar información de sesión cada minuto
            setInterval(updateLastActivity, 60000);
            
            // Auto-logout después de 30 minutos de inactividad
            let activityTimer;
            function resetActivityTimer() {
                clearTimeout(activityTimer);
                activityTimer = setTimeout(() => {
                    if (confirm('Tu sesión está por expirar por inactividad. ¿Deseas continuar?')) {
                        resetActivityTimer();
                        updateLastActivity();
                    } else {
                        auth.logout();
                    }
                }, 30 * 60 * 1000); // 30 minutos
            }
            
            // Resetear timer con actividad del usuario
            ['click', 'keypress', 'mousemove', 'scroll'].forEach(event => {
                document.addEventListener(event, resetActivityTimer, { passive: true });
            });
            
            resetActivityTimer();
        });
        
        function loadStats() {
            try {
                const data = JSON.parse(localStorage.getItem('horasExtrasData') || '{}');
                const history = data.history || [];
                
                // Estadísticas básicas
                document.getElementById('totalCalculos').textContent = history.length;
                
                const totalHoras = history.reduce((sum, item) => sum + (item.total_hours || 0), 0);
                document.getElementById('totalHoras').textContent = totalHoras.toFixed(0);
                
                const totalImporte = history.reduce((sum, item) => sum + (item.amount || 0), 0);
                document.getElementById('totalImporte').textContent = totalImporte.toFixed(2) + '€';
                
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }
        
        function loadRecentActivity() {
            try {
                const logs = JSON.parse(localStorage.getItem('horasExtrasLogs') || '[]');
                const user = auth.getCurrentUser();
                
                // Filtrar logs del usuario actual (últimos 10)
                const userLogs = logs
                    .filter(log => log.userId === user.id)
                    .slice(-10)
                    .reverse();
                
                const activityList = document.getElementById('activityList');
                
                if (userLogs.length === 0) {
                    activityList.innerHTML = `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="activity-content">
                                <p>No hay actividad reciente</p>
                                <div class="activity-time">--</div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                userLogs.forEach(log => {
                    let icon = 'fa-info-circle';
                    let text = log.details;
                    
                    switch(log.action) {
                        case 'login': icon = 'fa-sign-in-alt'; break;
                        case 'logout': icon = 'fa-sign-out-alt'; break;
                        case 'calculation': icon = 'fa-calculator'; break;
                        case 'export': icon = 'fa-download'; break;
                        case 'import': icon = 'fa-upload'; break;
                        case 'config_change': icon = 'fa-cog'; break;
                    }
                    
                    const time = new Date(log.timestamp);
                    const timeStr = time.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    
                    html += `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="activity-content">
                                <p>${text}</p>
                                <div class="activity-time">${timeStr}</div>
                            </div>
                        </div>
                    `;
                });
                
                activityList.innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando actividad:', error);
            }
        }
        
        function updateLastActivity() {
            const session = JSON.parse(localStorage.getItem('horasExtrasSession') || 'null');
            const user = auth.getCurrentUser();
            
            if (session && user) {
                const expires = new Date(session.expires);
                const now = new Date();
                const diffMs = expires - now;
                const diffMins = Math.floor(diffMs / 60000);
                
                document.getElementById('sessionInfo').textContent = 
                    `Usuario: ${user.name} | Sesión expira en: ${diffMins} minutos`;
                
                // Actualizar último login
                const users = JSON.parse(localStorage.getItem('horasExtrasUsers') || '[]');
                const userIndex = users.findIndex(u => u.id === user.id);
                
                if (userIndex !== -1 && users[userIndex].lastLogin) {
                    const lastLogin = new Date(users[userIndex].lastLogin);
                    document.getElementById('lastLogin').textContent = 
                        `Último acceso: ${lastLogin.toLocaleDateString()} ${lastLogin.toLocaleTimeString()}`;
                }
            }
        }
    </script>
</body>
</html>